"use strict";function ownKeys(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],i=!0,s=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);i=!0);}catch(e){s=!0,o=e}finally{try{i||null==n.return||n.return()}finally{if(s)throw o}}return a}}function _unsupportedIterableToArray(e,t){var n;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function createCustomError(e){function t(e,t){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.message=e,this.code=t}return(t.prototype=new Error).name=e,t.prototype.constructor=t}Object.defineProperty(exports,"__esModule",{value:!0});var LDUnexpectedResponseError=createCustomError("LaunchDarklyUnexpectedResponseError"),LDInvalidEnvironmentIdError=createCustomError("LaunchDarklyInvalidEnvironmentIdError"),LDInvalidUserError=createCustomError("LaunchDarklyInvalidUserError"),LDInvalidEventKeyError=createCustomError("LaunchDarklyInvalidEventKeyError"),LDInvalidArgumentError=createCustomError("LaunchDarklyInvalidArgumentError"),LDFlagFetchError=createCustomError("LaunchDarklyFlagFetchError"),LDInvalidDataError=createCustomError("LaunchDarklyInvalidDataError");function isHttpErrorRecoverable(e){return!(400<=e&&e<500)||(400===e||408===e||429===e)}for(var errors=Object.freeze({__proto__:null,LDUnexpectedResponseError:LDUnexpectedResponseError,LDInvalidEnvironmentIdError:LDInvalidEnvironmentIdError,LDInvalidUserError:LDInvalidUserError,LDInvalidEventKeyError:LDInvalidEventKeyError,LDInvalidArgumentError:LDInvalidArgumentError,LDFlagFetchError:LDFlagFetchError,LDInvalidDataError:LDInvalidDataError,isHttpErrorRecoverable:isHttpErrorRecoverable}),fromByteArray_1=fromByteArray,lookup=[],revLookup=[],code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function tripletToBase64(e){return lookup[e>>18&63]+lookup[e>>12&63]+lookup[e>>6&63]+lookup[63&e]}function encodeChunk(e,t,n){for(var r,o=[],a=t;a<n;a+=3)r=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),o.push(tripletToBase64(r));return o.join("")}function fromByteArray(e){for(var t,n=e.length,r=n%3,o=[],a=0,i=n-r;a<i;a+=16383)o.push(encodeChunk(e,a,i<a+16383?i:a+16383));return 1==r?(t=e[n-1],o.push(lookup[t>>2]+lookup[t<<4&63]+"==")):2==r&&(t=(e[n-2]<<8)+e[n-1],o.push(lookup[t>>10]+lookup[t>>4&63]+lookup[t<<2&63]+"=")),o.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63;var isArray=Array.isArray,keyList=Object.keys,hasProp=Object.prototype.hasOwnProperty,fastDeepEqual=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){var r,o,a=isArray(t),i=isArray(n);if(a&&i){if((s=t.length)!=n.length)return!1;for(r=s;0!=r--;)if(!e(t[r],n[r]))return!1}else{if(a!=i)return!1;a=t instanceof Date,i=n instanceof Date;if(a!=i)return!1;if(a&&i)return t.getTime()==n.getTime();a=t instanceof RegExp,i=n instanceof RegExp;if(a!=i)return!1;if(a&&i)return t.toString()==n.toString();var s,u=keyList(t);if((s=u.length)!==keyList(n).length)return!1;for(r=s;0!=r--;)if(!hasProp.call(n,u[r]))return!1;for(r=s;0!=r--;)if(!e(t[o=u[r]],n[o]))return!1}return!0}return t!=t&&n!=n},userAttrsToStringify=["key","secondary","ip","country","email","firstName","lastName","avatar","name"];function appendUrlPath(e,t){return(e.endsWith("/")?e.substring(0,e.length-1):e)+(t.startsWith("/")?"":"/")+t}function btoa(e){e=unescape(encodeURIComponent(e));return fromByteArray_1(stringToBytes(e))}function stringToBytes(e){for(var t=[],n=0;n<e.length;n++)t.push(e.charCodeAt(n));return t}function base64URLEncode(e){return btoa(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function clone(e){return JSON.parse(JSON.stringify(e))}function deepEquals(e,t){return fastDeepEqual(e,t)}function onNextTick(e){setTimeout(e,0)}function wrapPromiseCallback(e,t){e=e.then(function(e){return t&&setTimeout(function(){t(null,e)},0),e},function(e){if(!t)return Promise.reject(e);setTimeout(function(){t(e,null)},0)});return t?void 0:e}function transformValuesToVersionedValues(e){var t,n={};for(t in e)objectHasOwnProperty(e,t)&&(n[t]={value:e[t],version:0});return n}function transformVersionedValuesToValues(e){var t,n={};for(t in e)objectHasOwnProperty(e,t)&&(n[t]=e[t].value);return n}function chunkUserEventsForUrl(e,t){for(var n,r=t.slice(0),o=[],a=e;0<r.length;){for(n=[];0<a;){var i=r.shift();if(!i)break;(a-=base64URLEncode(JSON.stringify(i)).length)<0&&0<n.length?r.unshift(i):n.push(i)}a=e,o.push(n)}return o}function getLDUserAgentString(e){var t=e.version||"3.8.2";return e.userAgent+"/"+t}function extend(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t){return _objectSpread2(_objectSpread2({},e),t)},{})}function objectHasOwnProperty(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function sanitizeUser(e){if(!e)return e;var t,n;for(n in userAttrsToStringify){var r=userAttrsToStringify[n],o=e[r];void 0!==o&&"string"!=typeof o&&((t=t||_objectSpread2({},e))[r]=String(o))}return t||e}var utils=Object.freeze({__proto__:null,appendUrlPath:appendUrlPath,btoa:btoa,base64URLEncode:base64URLEncode,clone:clone,deepEquals:deepEquals,onNextTick:onNextTick,wrapPromiseCallback:wrapPromiseCallback,transformValuesToVersionedValues:transformValuesToVersionedValues,transformVersionedValuesToValues:transformVersionedValuesToValues,chunkUserEventsForUrl:chunkUserEventsForUrl,getLDUserAgentString:getLDUserAgentString,extend:extend,objectHasOwnProperty:objectHasOwnProperty,sanitizeUser:sanitizeUser});function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}for(var rngBrowser=createCommonjsModule(function(e){var t,n,r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);r?(t=new Uint8Array(16),e.exports=function(){return r(t),t}):(n=new Array(16),e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),n[t]=e>>>((3&t)<<3)&255;return n})}),byteToHex=[],i$1=0;i$1<256;++i$1)byteToHex[i$1]=(i$1+256).toString(16).substr(1);function bytesToUuid(e,t){var t=t||0,n=byteToHex;return[n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[+t]]].join("")}var _nodeId,_clockseq,bytesToUuid_1=bytesToUuid,_lastMSecs=0,_lastNSecs=0;function v1(e,t,n){var r=t&&n||0,o=t||[],a=(e=e||{}).node||_nodeId,n=void 0!==e.clockseq?e.clockseq:_clockseq,i=(null!=a&&null!=n||(i=rngBrowser(),null==a&&(a=_nodeId=[1|i[0],i[1],i[2],i[3],i[4],i[5]]),null==n&&(n=_clockseq=16383&(i[6]<<8|i[7]))),void 0!==e.msecs?e.msecs:(new Date).getTime()),s=void 0!==e.nsecs?e.nsecs:_lastNSecs+1,u=i-_lastMSecs+(s-_lastNSecs)/1e4;if(u<0&&void 0===e.clockseq&&(n=n+1&16383),1e4<=(s=(u<0||_lastMSecs<i)&&void 0===e.nsecs?0:s))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");_lastMSecs=i,_clockseq=n;u=(1e4*(268435455&(i+=122192928e5))+(_lastNSecs=s))%4294967296,o[r++]=u>>>24&255,o[r++]=u>>>16&255,o[r++]=u>>>8&255,o[r++]=255&u,e=i/4294967296*1e4&268435455;o[r++]=e>>>8&255,o[r++]=255&e,o[r++]=e>>>24&15|16,o[r++]=e>>>16&255,o[r++]=n>>>8|128,o[r++]=255&n;for(var c=0;c<6;++c)o[r+c]=a[c];return t||bytesToUuid_1(o)}var v1_1=v1,logLevels=["debug","info","warn","error","none"];function commonBasicLogger(e,s){if(e&&e.destination&&"function"!=typeof e.destination)throw new Error("destination for basicLogger was set to a non-function");function t(t){return function(e){console&&console[t]&&console[t].call(console,e)}}var u=e&&e.destination?[e.destination,e.destination,e.destination,e.destination]:[t("log"),t("info"),t("warn"),t("error")],c=!(!e||!e.destination),l=e&&void 0!==e.prefix&&null!==e.prefix?e.prefix:"[LaunchDarkly] ",n=1;if(e&&e.level)for(var r=0;r<logLevels.length;r++)logLevels[r]===e.level&&(n=r);for(var o={},a=function(e){var a,i=logLevels[e];"none"!==i&&(e<n?o[i]=function(){}:(a=e,o[i]=function(){var e=a,t=i,n=arguments;if(!(n.length<1)){var r=c?t+": "+l:l,o=1!==n.length&&s?((o=_toConsumableArray(n))[0]=r+o[0],s.apply(void 0,_toConsumableArray(o))):r+n[0];try{u[e](o)}catch(e){console&&console.log&&console.log("[LaunchDarkly] Configured logger's "+t+" method threw an exception: "+e)}}}))},i=0;i<logLevels.length;i++)a(i);return o}function validateLogger(t){logLevels.forEach(function(e){if("none"!==e&&(!t[e]||"function"!=typeof t[e]))throw new Error("Provided logger instance must support logger."+e+"(...) method")})}function createConsoleLogger(e,t){return commonBasicLogger({level:e,prefix:t})}function errorString(e){return e&&e.message?e.message:"string"==typeof e||e instanceof String?e:JSON.stringify(e)}var clientInitialized=function(){return"LaunchDarkly client initialized"},docLink=" Please see https://docs.launchdarkly.com/sdk/client-side/javascript#initializing-the-client for instructions on SDK initialization.",clientNotReady=function(){return"LaunchDarkly client is not ready"},eventCapacityExceeded=function(){return"Exceeded event queue capacity. Increase capacity to avoid dropping events."},eventWithoutUser=function(){return"Be sure to call `identify` in the LaunchDarkly client: https://docs.launchdarkly.com/sdk/features/identify#javascript"},invalidContentType=function(e){return'Expected application/json content type but got "'+e+'"'},invalidKey=function(){return"Event key must be a string"},localStorageUnavailable=function(e){return"local storage is unavailable: "+errorString(e)},networkError=function(e){return"network error"+(e?" ("+e+")":"")},unknownCustomEventKey=function(e){return'Custom event "'+e+'" does not exist'},environmentNotFound=function(){return"Environment not found. Double check that you specified a valid environment/client-side ID."+docLink},environmentNotSpecified=function(){return"No environment/client-side ID was specified."+docLink},errorFetchingFlags=function(e){return"Error fetching flag settings: "+errorString(e)},userNotSpecified=function(){return"No user specified."+docLink},invalidUser=function(){return"Invalid user specified."+docLink},invalidData=function(){return"Invalid data received from LaunchDarkly; connection may have been interrupted"},bootstrapOldFormat=function(){return"LaunchDarkly client was initialized with bootstrap data that did not include flag metadata. Events may not be sent correctly."+docLink},bootstrapInvalid=function(){return"LaunchDarkly bootstrap data is not available because the back end could not read the flags."},deprecated=function(e,t){return t?'"'+e+'" is deprecated, please use "'+t+'"':'"'+e+'" is deprecated'},httpErrorMessage=function(e,t,n){return"Received error "+e+(401===e?" (invalid SDK key)":"")+" for "+t+" - "+(isHttpErrorRecoverable(e)?n:"giving up permanently")},httpUnavailable=function(){return"Cannot make HTTP requests in this environment."+docLink},identifyDisabled=function(){return"identify() has no effect here; it must be called on the main client instance"},streamClosing=function(){return"Closing stream connection"},streamConnecting=function(e){return"Opening stream connection to "+e},streamError=function(e,t){return"Error on stream connection: "+errorString(e)+", will continue retrying after "+t+" milliseconds."},unrecoverableStreamError=function(e){return"Error on stream connection ".concat(errorString(e),", giving up permanently")},unknownOption=function(e){return'Ignoring unknown config option "'+e+'"'},wrongOptionType=function(e,t,n){return'Config option "'+e+'" should be of type '+t+", got "+n+", using default value"},wrongOptionTypeBoolean=function(e,t){return'Config option "'+e+'" should be a boolean, got '+t+", converting to boolean"},optionBelowMinimum=function(e,t,n){return'Config option "'+e+'" was set to '+t+", changing to minimum value of "+n},debugPolling=function(e){return"polling for feature flags at "+e},debugStreamPing=function(){return"received ping message from stream"},debugStreamPut=function(){return"received streaming update for all flags"},debugStreamPatch=function(e){return'received streaming update for flag "'+e+'"'},debugStreamPatchIgnored=function(e){return'received streaming update for flag "'+e+'" but ignored due to version check'},debugStreamDelete=function(e){return'received streaming deletion for flag "'+e+'"'},debugStreamDeleteIgnored=function(e){return'received streaming deletion for flag "'+e+'" but ignored due to version check'},debugEnqueueingEvent=function(e){return'enqueueing "'+e+'" event'},debugPostingEvents=function(e){return"sending "+e+" events"},debugPostingDiagnosticEvent=function(e){return"sending diagnostic event ("+e.kind+")"},invalidTagValue=function(e){return'Config option "'.concat(e,'" must only contain letters, numbers, ., _ or -.')},invalidInspector=function(e,t){return'an inspector: "'.concat(t,'" of an invalid type (').concat(e,") was configured")},inspectorMethodError=function(e,t){return'an inspector: "'.concat(t,'" of type: "').concat(e,'" generated an exception')},tagValueTooLong=function(e){return'Value of "'.concat(e,'" was longer than 64 characters and was discarded.')},messages=Object.freeze({__proto__:null,clientInitialized:clientInitialized,clientNotReady:clientNotReady,eventCapacityExceeded:eventCapacityExceeded,eventWithoutUser:eventWithoutUser,invalidContentType:invalidContentType,invalidKey:invalidKey,localStorageUnavailable:localStorageUnavailable,networkError:networkError,unknownCustomEventKey:unknownCustomEventKey,environmentNotFound:environmentNotFound,environmentNotSpecified:environmentNotSpecified,errorFetchingFlags:errorFetchingFlags,userNotSpecified:userNotSpecified,invalidUser:invalidUser,invalidData:invalidData,bootstrapOldFormat:bootstrapOldFormat,bootstrapInvalid:bootstrapInvalid,deprecated:deprecated,httpErrorMessage:httpErrorMessage,httpUnavailable:httpUnavailable,identifyDisabled:identifyDisabled,streamClosing:streamClosing,streamConnecting:streamConnecting,streamError:streamError,unrecoverableStreamError:unrecoverableStreamError,unknownOption:unknownOption,wrongOptionType:wrongOptionType,wrongOptionTypeBoolean:wrongOptionTypeBoolean,optionBelowMinimum:optionBelowMinimum,debugPolling:debugPolling,debugStreamPing:debugStreamPing,debugStreamPut:debugStreamPut,debugStreamPatch:debugStreamPatch,debugStreamPatchIgnored:debugStreamPatchIgnored,debugStreamDelete:debugStreamDelete,debugStreamDeleteIgnored:debugStreamDeleteIgnored,debugEnqueueingEvent:debugEnqueueingEvent,debugPostingEvents:debugPostingEvents,debugPostingDiagnosticEvent:debugPostingDiagnosticEvent,invalidTagValue:invalidTagValue,invalidInspector:invalidInspector,inspectorMethodError:inspectorMethodError,tagValueTooLong:tagValueTooLong}),baseOptionDefs={baseUrl:{default:"https://app.launchdarkly.com"},streamUrl:{default:"https://clientstream.launchdarkly.com"},eventsUrl:{default:"https://events.launchdarkly.com"},sendEvents:{default:!0},streaming:{type:"boolean"},sendLDHeaders:{default:!0},requestHeaderTransform:{type:"function"},inlineUsersInEvents:{default:!1},allowFrequentDuplicateEvents:{default:!1},sendEventsOnlyForVariation:{default:!1},useReport:{default:!1},evaluationReasons:{default:!1},eventCapacity:{default:100,minimum:1},flushInterval:{default:2e3,minimum:2e3},samplingInterval:{default:0,minimum:0},streamReconnectDelay:{default:1e3,minimum:0},allAttributesPrivate:{default:!1},privateAttributeNames:{default:[]},bootstrap:{type:"string|object"},diagnosticRecordingInterval:{default:9e5,minimum:2e3},diagnosticOptOut:{default:!1},wrapperName:{type:"string"},wrapperVersion:{type:"string"},stateProvider:{type:"object"},autoAliasingOptOut:{default:!1},application:{validator:applicationConfigValidator},inspectors:{default:[]}},allowedTagCharacters=/^(\w|\.|-)+$/;function validateTagValue(e,t,n){if("string"==typeof t&&t.match(allowedTagCharacters)){if(!(64<t.length))return t;n.warn(tagValueTooLong(e))}else n.warn(invalidTagValue(e))}function applicationConfigValidator(e,t,n){var r={};return t.id&&(r.id=validateTagValue("".concat(e,".id"),t.id,n)),t.version&&(r.version=validateTagValue("".concat(e,".version"),t.version,n)),r}function validate(e,t,n,i){var s=extend({logger:{default:i}},baseOptionDefs,n),r={all_attributes_private:"allAttributesPrivate",private_attribute_names:"privateAttributeNames",samplingInterval:null,allowFrequentDuplicateEvents:void 0};function u(e){onNextTick(function(){t&&t.maybeReportError(new LDInvalidArgumentError(e))})}var o,a,c,l,n=extend({},e||{});function d(e){return null===e?"any":void 0!==e?Array.isArray(e)?"array":"boolean"===(e=_typeof(e))||"string"===e||"number"===e||"function"===e?e:"object":void 0}return o=n,Object.keys(r).forEach(function(e){var t;void 0!==o[e]&&(t=r[e],i&&i.warn(deprecated(e,t)),t&&(void 0===o[t]&&(o[t]=o[e]),delete o[e]))}),a=extend({},n),Object.keys(s).forEach(function(e){void 0!==a[e]&&null!==a[e]||(a[e]=s[e]&&s[e].default)}),l=extend({},c=n=a),Object.keys(c).forEach(function(e){var t,n,r,o,a=c[e];null!=a&&(void 0===(t=s[e])?u(unknownOption(e)):(n=t.type||d(t.default),(r=t.validator)?void 0!==(r=r(e,c[e],i))?l[e]=r:delete l[e]:"any"!==n&&(r=n.split("|"),o=d(a),r.indexOf(o)<0?"boolean"===n?(l[e]=!!a,u(wrongOptionTypeBoolean(e,o))):(u(wrongOptionType(e,n,o)),l[e]=t.default):"number"===o&&void 0!==t.minimum&&a<t.minimum&&(u(optionBelowMinimum(e,a,t.minimum)),l[e]=t.minimum))))}),validateLogger((n=l).logger),n}function getTags(e){var t={};return e&&(e.application&&void 0!==e.application.id&&null!==e.application.id&&(t["application-id"]=[e.application.id]),e.application&&void 0!==e.application.version&&null!==e.application.id&&(t["application-version"]=[e.application.version])),t}var configuration=Object.freeze({__proto__:null,baseOptionDefs:baseOptionDefs,validate:validate,getTags:getTags});function getLDHeaders(e,t){var n;return t&&!t.sendLDHeaders?{}:(e={"X-LaunchDarkly-User-Agent":getLDUserAgentString(e)},t&&t.wrapperName&&(e["X-LaunchDarkly-Wrapper"]=t.wrapperVersion?t.wrapperName+"/"+t.wrapperVersion:t.wrapperName),n=getTags(t),(t=Object.keys(n)).length&&(e["x-launchdarkly-tags"]=t.sort().map(function(t){return Array.isArray(n[t])?n[t].sort().map(function(e){return"".concat(t,"/").concat(e)}):["".concat(t,"/").concat(n[t])]}).reduce(function(e,t){return e.concat(t)},[]).join(" ")),e)}function transformHeaders(e,t){return t&&t.requestHeaderTransform?t.requestHeaderTransform(_objectSpread2({},e)):e}var MAX_URL_LENGTH=2e3;function EventSender(s,e,u){var c="/a/"+e+".gif",l=extend({"Content-Type":"application/json"},getLDHeaders(s,u)),d=s.httpFallbackPing,f={};return f.sendChunk=function(e,t,r,n){var o=JSON.stringify(e),a=r?null:v1_1();function i(n){var e=r?l:extend({},l,{"X-LaunchDarkly-Event-Schema":"3","X-LaunchDarkly-Payload-ID":a});return s.httpRequest("POST",t,transformHeaders(e,u),o).promise.then(function(e){var t;if(e)return 400<=e.status&&isHttpErrorRecoverable(e.status)&&n?i(!1):(t={status:(e=e).status},(e=(e=e.header("date"))&&Date.parse(e))&&(t.serverTime=e),t)}).catch(function(){return n?i(!1):Promise.reject()})}return n?i(!0).catch(function(){}):(d&&d(t+c+"?d="+base64URLEncode(o)),Promise.resolve())},f.sendEvents=function(e,t,n){if(!s.httpRequest)return Promise.resolve();for(var r=s.httpAllowsPost(),o=r?[e]:chunkUserEventsForUrl(MAX_URL_LENGTH-t.length,e),a=[],i=0;i<o.length;i++)a.push(f.sendChunk(o[i],t,n,r));return Promise.all(a)},f}function EventSummarizer(){var e={},i=0,s=0,u={};return e.summarizeEvent=function(e){var t,n;"feature"===e.kind&&(t=e.key+":"+(null!==e.variation&&void 0!==e.variation?e.variation:"")+":"+(null!==e.version&&void 0!==e.version?e.version:""),(n=u[t])?n.count=n.count+1:u[t]={count:1,key:e.key,variation:e.variation,version:e.version,value:e.value,default:e.default},(0===i||e.creationDate<i)&&(i=e.creationDate),e.creationDate>s&&(s=e.creationDate))},e.getSummary=function(){var e,t={},n=!0;for(e in u){var r=u[e],o=t[r.key],a=(o||(o={default:r.default,counters:[]},t[r.key]=o),{value:r.value,count:r.count});void 0!==r.variation&&null!==r.variation&&(a.variation=r.variation),r.version?a.version=r.version:a.unknown=!0,o.counters.push(a),n=!1}return n?null:{startDate:i,endDate:s,features:t}},e.clearSummary=function(){s=i=0,u={}},e}function UserFilter(e){var t={},i=e.allAttributesPrivate,s=e.privateAttributeNames||[],u={key:!0,custom:!0,anonymous:!0},c={key:!0,secondary:!0,ip:!0,country:!0,email:!0,firstName:!0,lastName:!0,avatar:!0,name:!0,anonymous:!0,custom:!0};return t.filterUser=function(e){var t,o,n,r,a;return e?(t=e.privateAttributeNames||[],o=function(e){return!u[e]&&(i||-1!==t.indexOf(e)||-1!==s.indexOf(e))},n=(r=(a=function(n,r){return Object.keys(n).reduce(function(e,t){return r(t)&&(o(t)?e[1][t]=!0:e[0][t]=n[t]),e},[{},{}])})(e,function(e){return c[e]}))[0],r=r[1],e.custom&&(a=a(e.custom,function(){return 1}),n.custom=a[0],r=extend({},r,a[1])),(e=Object.keys(r)).length&&(e.sort(),n.privateAttrs=e),n):null},t}function EventProcessor(e,t,n){var r,o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,i={},s=(5<arguments.length&&void 0!==arguments[5]?arguments[5]:null)||EventSender(e,n,t),u=appendUrlPath(t.eventsUrl,"/events/bulk/"+n),c=EventSummarizer(),l=UserFilter(t),d=t.inlineUsersInEvents,f=t.samplingInterval,g=t.eventCapacity,v=t.flushInterval,p=t.logger,m=[],y=0,h=!1,b=!1;function E(){return 0===f||0===Math.floor(Math.random()*f)}function k(e){m.length<g?(m.push(e),b=!1):(b||(b=!0,p.warn(eventCapacityExceeded())),o&&o.incrementDroppedEvents())}return i.enqueue=function(e){var t,n,r;h||(t=r=!1,c.summarizeEvent(e),"feature"===e.kind?E()&&(r=!!e.trackEvents,t=!!(n=e).debugEventsUntilDate&&(n.debugEventsUntilDate>y&&n.debugEventsUntilDate>(new Date).getTime())):r=E(),r&&k((r=extend({},n=e),"alias"!==n.kind&&(d||"identify"===n.kind?r.user=l.filterUser(n.user):(r.userKey=n.user.key,delete r.user),"feature"===n.kind&&(delete r.trackEvents,delete r.debugEventsUntilDate)),r)),t&&((r=extend({},e,{kind:"debug"})).user=l.filterUser(r.user),delete r.trackEvents,delete r.debugEventsUntilDate,k(r)))},i.flush=function(){var e,t;return h||(e=m,t=c.getSummary(),c.clearSummary(),t&&(t.kind="summary",e.push(t)),o&&o.setEventsInLastBatch(e.length),0===e.length)?Promise.resolve():(m=[],p.debug(debugPostingEvents(e.length)),s.sendEvents(e,u).then(function(e){e&&(e.serverTime&&(y=e.serverTime),isHttpErrorRecoverable(e.status)||(h=!0),400<=e.status&&onNextTick(function(){a.maybeReportError(new LDUnexpectedResponseError(httpErrorMessage(e.status,"event posting","some events were dropped")))}))}))},i.start=function(){r=setTimeout(function e(){i.flush(),r=setTimeout(e,v)},v)},i.stop=function(){clearTimeout(r)},i}function EventEmitter(t){var e={},o={};return e.on=function(e,t,n){o[e]=o[e]||[],o[e]=o[e].concat({handler:t,context:n})},e.off=function(e,t,n){if(o[e])for(var r=0;r<o[e].length;r++)o[e][r].handler===t&&o[e][r].context===n&&(o[e]=o[e].slice(0,r).concat(o[e].slice(r+1)))},e.emit=function(e){if(o[e])for(var t=o[e].slice(0),n=0;n<t.length;n++)t[n].handler.apply(t[n].context,Array.prototype.slice.call(arguments,1))},e.getEvents=function(){return Object.keys(o)},e.getEventListenerCount=function(e){return o[e]?o[e].length:0},e.maybeReportError=function(e){e&&(o["error"]?this.emit("error",e):(t||console).error(e.message))},e}var readyEvent="ready",successEvent="initialized",failureEvent="failed";function InitializationStateTracker(o){var t=!1,n=!1,r=null,e=null,a=new Promise(function(t){o.on(readyEvent,function e(){o.off(readyEvent,e),t()})}).catch(function(){});return{getInitializationPromise:function(){if(!e){if(t)return Promise.resolve();if(n)return Promise.reject(r);e=new Promise(function(t,n){function r(e){o.off(failureEvent,r),n(e)}o.on(successEvent,function e(){o.off(successEvent,e),t()}),o.on(failureEvent,r)})}return e},getReadyPromise:function(){return a},signalSuccess:function(){t||n||(t=!0,o.emit(successEvent),o.emit(readyEvent))},signalFailure:function(e){t||n||(n=!0,r=e,o.emit(failureEvent,e),o.emit(readyEvent)),o.maybeReportError(e)}}}var InitializationState=InitializationStateTracker;function PersistentFlagStore(t,n,r,o){var a={};function i(){var e="",t=o.getUser();return t&&(e=r||btoa(JSON.stringify(t))),"ld:"+n+":"+e}return a.loadFlags=function(){return t.get(i()).then(function(e){if(null==e)return null;try{var t,n=JSON.parse(e);return n&&(void 0===(t=n.$schema)||t<1?n=transformValuesToVersionedValues(n):delete n.$schema),n}catch(e){return a.clearFlags().then(function(){return null})}})},a.saveFlags=function(e){e=extend({},e,{$schema:1});return t.set(i(),JSON.stringify(e))},a.clearFlags=function(){return t.clear(i())},a}function PersistentStorage(r,t){function o(e){n||(n=!0,t.warn(localStorageUnavailable(e)))}var e={},n=!1;return e.isEnabled=function(){return!!r},e.get=function(e){return new Promise(function(t){r?r.get(e).then(t).catch(function(e){o(e),t(void 0)}):t(void 0)})},e.set=function(e,n){return new Promise(function(t){r?r.set(e,n).then(function(){return t(!0)}).catch(function(e){o(e),t(!1)}):t(!1)})},e.clear=function(e){return new Promise(function(t){r?r.clear(e).then(function(){return t(!0)}).catch(function(e){o(e),t(!1)}):t(!1)})},e}var streamReadTimeoutMillis=3e5,maxRetryDelay=3e4,jitterRatio=.5;function Stream(o,a,i,t){var s,u=a.streamUrl,c=a.logger,e={},l=appendUrlPath(u,"/eval/"+i),d=a.useReport,f=a.evaluationReasons,n=a.streamReconnectDelay,g=getLDHeaders(o,a),v=!1,p=null,m=null,y=null,h=null,b=null,E=0;function r(){e=n*Math.pow(2,E);var e=(e=maxRetryDelay<e?maxRetryDelay:e)-Math.trunc(Math.random()*jitterRatio*e);return E+=1,e}function k(e){var t;e.status&&"number"==typeof e.status&&!isHttpErrorRecoverable(e.status)?(w(),c.error(unrecoverableStreamError(e)),m&&(clearTimeout(m),m=null)):(t=r(),v||(c.warn(streamError(e,t)),v=!0),I(!1),w(),D(t))}function D(e){m||(e?m=setTimeout(S,e):S())}function S(){m=null;var e,t="",n={headers:g,readTimeoutMillis:streamReadTimeoutMillis};if(o.eventSourceFactory){for(var r in null!=h&&(t="h="+h),d?o.eventSourceAllowsReport?(e=l,n.method="REPORT",n.headers["Content-Type"]="application/json",n.body=JSON.stringify(y)):(e=appendUrlPath(u,"/ping/"+i),t=""):e=l+"/"+base64URLEncode(JSON.stringify(y)),n.headers=transformHeaders(n.headers,a),e=e+((t=f?t+(t?"&":"")+"withReasons=true":t)?"?":"")+t,w(),c.info(streamConnecting(e)),s=(new Date).getTime(),p=o.eventSourceFactory(e,n),b)objectHasOwnProperty(b,r)&&p.addEventListener(r,b[r]);p.onerror=k,p.onopen=function(){E=0}}}function w(){p&&(c.info(streamClosing()),p.close(),p=null)}function I(e){s&&t&&t.recordStreamInit(s,!e,(new Date).getTime()-s),s=null}return e.connect=function(e,t,n){y=e,h=t,b={};for(var r in n||{})!function(t){b[t]=function(e){I(!(v=!1)),n[t]&&n[t](e)}}(r);D()},e.disconnect=function(){clearTimeout(m),m=null,w()},e.isConnected=function(){return!!(p&&o.eventSourceIsActive&&o.eventSourceIsActive(p))},e}function promiseCoalescer(n){var r,o,a,i,e={addPromise:function(t,e){r=t,o&&o(),o=e,t.then(function(e){r===t&&(a(e),n&&n())},function(e){r===t&&(i(e),n&&n())})}};return e.resultPromise=new Promise(function(e,t){a=e,i=t}),e}var jsonContentType="application/json";function getResponseError(e){return 404===e.status?new LDInvalidEnvironmentIdError(environmentNotFound()):new LDFlagFetchError(errorFetchingFlags(e.statusText||String(e.status)))}function Requestor(i,s,a){var u=s.baseUrl,c=s.useReport,l=s.evaluationReasons,d=s.logger,e={},f={};function g(e,t){var n,r,o,a;return i.httpRequest?(a=t?"REPORT":"GET",n=getLDHeaders(i,s),t&&(n["Content-Type"]=jsonContentType),(r=f[e])||(r=promiseCoalescer(function(){delete f[e]}),f[e]=r),a=(o=i.httpRequest(a,e,transformHeaders(n,s),t)).promise.then(function(e){var t;return 200===e.status?e.header("content-type")&&e.header("content-type").substring(0,jsonContentType.length)===jsonContentType?JSON.parse(e.body):(t=invalidContentType(e.header("content-type")||""),Promise.reject(new LDFlagFetchError(t))):Promise.reject(getResponseError(e))},function(e){return Promise.reject(new LDFlagFetchError(networkError(e)))}),r.addPromise(a,function(){o.cancel&&o.cancel()}),r.resultPromise):new Promise(function(e,t){t(new LDFlagFetchError(httpUnavailable()))})}return e.fetchJSON=function(e){return g(appendUrlPath(u,e),null)},e.fetchFlagSettings=function(e,t){var n,r,o="";return c?(n=[u,"/sdk/evalx/",a,"/user"].join(""),r=JSON.stringify(e)):(e=base64URLEncode(JSON.stringify(e)),n=[u,"/sdk/evalx/",a,"/users/",e].join("")),t&&(o="h="+t),d.debug(debugPolling(n=n+((o=l?o+(o?"&":"")+"withReasons=true":o)?"?":"")+o)),g(n,r)},e}function Identity(e,n){var r,t={setUser:function(e){var t=r&&clone(r);(r=sanitizeUser(e))&&n&&n(clone(r),t)},getUser:function(){return r?clone(r):null}};return e&&t.setUser(e),t}var ldUserIdKey="ld:$anonUserId";function UserValidator(n){var e={};return e.validateUser=function(e){var t;return e?null!==(t=clone(e)).key&&void 0!==t.key?(t.key=t.key.toString(),Promise.resolve(t)):t.anonymous?n.get(ldUserIdKey).then(function(e){return e?(t.key=e,t):(e=v1_1(),t.key=e,n.set(ldUserIdKey,e).then(function(){return t}))}):Promise.reject(new LDInvalidUserError(invalidUser())):Promise.reject(new LDInvalidUserError(userNotSpecified()))},e}var baseOptionDefs$1=configuration.baseOptionDefs,appendUrlPath$1=utils.appendUrlPath;function DiagnosticId(e){var t={diagnosticId:v1_1()};return e&&(t.sdkKeySuffix=6<e.length?e.substring(e.length-6):e),t}function DiagnosticsAccumulator(e){var t,n,r,o;function a(e){t=e,r=n=0,o=[]}return a(e),{getProps:function(){return{dataSinceDate:t,droppedEvents:n,eventsInLastBatch:r,streamInits:o}},setProps:function(e){t=e.dataSinceDate,n=e.droppedEvents||0,r=e.eventsInLastBatch||0,o=e.streamInits||[]},incrementDroppedEvents:function(){n++},setEventsInLastBatch:function(e){r=e},recordStreamInit:function(e,t,n){o.push({timestamp:e,failed:t,durationMillis:n})},reset:a}}function DiagnosticsManager(t,r,e,n,o,a,i){var s,u,c=!!t.diagnosticUseCombinedEvent,l="ld:"+o+":$diagnostics",d=appendUrlPath$1(a.eventsUrl,"/events/diagnostic/"+o),f=a.diagnosticRecordingInterval,g=e,v=!!a.streaming,o={};function p(){return{sdk:function(){var e=_objectSpread2({},t.diagnosticSdkData);a.wrapperName&&(e.wrapperName=a.wrapperName);a.wrapperVersion&&(e.wrapperVersion=a.wrapperVersion);return e}(),configuration:{customBaseURI:a.baseUrl!==baseOptionDefs$1.baseUrl.default,customStreamURI:a.streamUrl!==baseOptionDefs$1.streamUrl.default,customEventsURI:a.eventsUrl!==baseOptionDefs$1.eventsUrl.default,eventsCapacity:a.eventCapacity,eventsFlushIntervalMillis:a.flushInterval,reconnectTimeMillis:a.streamReconnectDelay,streamingDisabled:!v,allAttributesPrivate:!!a.allAttributesPrivate,inlineUsersInEvents:!!a.inlineUsersInEvents,diagnosticRecordingIntervalMillis:a.diagnosticRecordingInterval,usingSecureMode:!!a.hash,bootstrapMode:!!a.bootstrap,fetchGoalsDisabled:!a.fetchGoals,sendEventsOnlyForVariation:!!a.sendEventsOnlyForVariation,autoAliasingOptOut:!!a.autoAliasingOptOut},platform:t.diagnosticPlatformData}}function m(e){a.logger&&a.logger.debug(messages.debugPostingDiagnosticEvent(e)),n.sendEvents(e,d,!0).then(function(){}).catch(function(){})}function y(){var e,t;m((t=(new Date).getTime(),e=_objectSpread2({kind:c?"diagnostic-combined":"diagnostic",id:i,creationDate:t},g.getProps()),c&&(e=_objectSpread2(_objectSpread2({},e),p())),g.reset(t),e)),u=setTimeout(y,f),s=(new Date).getTime(),c&&r.isEnabled()&&(t=_objectSpread2({},g.getProps()),r.set(l,JSON.stringify(t)))}return o.start=function(){var n;c?(n=function(e){var t;e?(e=(s||0)+f)<=(t=(new Date).getTime())?y():u=setTimeout(y,e-t):0===Math.floor(4*Math.random())?y():u=setTimeout(y,f)},r.isEnabled()?r.get(l).then(function(e){if(e)try{var t=JSON.parse(e);g.setProps(t),s=t.dataSinceDate}catch(e){}n(!0)}).catch(function(){n(!1)}):n(!1)):(m(_objectSpread2({kind:"diagnostic-init",id:i,creationDate:g.getProps().dataSinceDate},p())),u=setTimeout(y,f))},o.stop=function(){u&&clearTimeout(u)},o.setStreaming=function(e){v=e},o}var diagnosticEvents={DiagnosticId:DiagnosticId,DiagnosticsAccumulator:DiagnosticsAccumulator,DiagnosticsManager:DiagnosticsManager},diagnosticEvents_1=diagnosticEvents.DiagnosticId,diagnosticEvents_2=diagnosticEvents.DiagnosticsAccumulator,diagnosticEvents_3=diagnosticEvents.DiagnosticsManager;function SafeInspector(e,t){var n=!1,r={type:e.type,name:e.name,method:function(){try{e.method.apply(e,arguments)}catch(e){n||(n=!0,t.warn(inspectorMethodError(r.type,r.name)))}}};return r}var InspectorTypes={flagUsed:"flag-used",flagDetailsChanged:"flag-details-changed",flagDetailChanged:"flag-detail-changed",clientIdentityChanged:"client-identity-changed"};function InspectorManager(e,t){var n,r={},o=(_defineProperty(n={},InspectorTypes.flagUsed,[]),_defineProperty(n,InspectorTypes.flagDetailsChanged,[]),_defineProperty(n,InspectorTypes.flagDetailChanged,[]),_defineProperty(n,InspectorTypes.clientIdentityChanged,[]),n);return(null==e?void 0:e.map(function(e){return SafeInspector(e,t)})).forEach(function(e){Object.prototype.hasOwnProperty.call(o,e.type)?o[e.type].push(e):t.warn(invalidInspector(e.type,e.name))}),r.hasListeners=function(e){return null==(e=o[e])?void 0:e.length},r.onFlagUsed=function(t,n,r){o[InspectorTypes.flagUsed].length&&onNextTick(function(){o[InspectorTypes.flagUsed].forEach(function(e){return e.method(t,n,r)})})},r.onFlags=function(t){o[InspectorTypes.flagDetailsChanged].length&&onNextTick(function(){o[InspectorTypes.flagDetailsChanged].forEach(function(e){return e.method(t)})})},r.onFlagChanged=function(t,n){o[InspectorTypes.flagDetailChanged].length&&onNextTick(function(){o[InspectorTypes.flagDetailChanged].forEach(function(e){return e.method(t,n)})})},r.onIdentityChanged=function(t){o[InspectorTypes.clientIdentityChanged].length&&onNextTick(function(){o[InspectorTypes.clientIdentityChanged].forEach(function(e){return e.method(t)})})},r}Object.freeze(InspectorTypes);var changeEvent="change",internalChangeEvent="internal-change";function initialize(F,x,e,o,t){var n,i,r,a,N,s,u,c=function(){if(e&&e.logger)return e.logger;return t&&t.logger&&t.logger.default||createConsoleLogger("warn")}(),l=EventEmitter(c),d=InitializationState(l),f=validate(e,l,t,c),g=InspectorManager(f.inspectors,c),v=f.sendEvents,p=F,m=f.hash,y=PersistentStorage(o.localStorage,c),V=EventSender(o,p,f),h=f.sendEvents&&!f.diagnosticOptOut,b=h?diagnosticEvents_1(p):null,E=h?diagnosticEvents_2((new Date).getTime()):null,k=h?diagnosticEvents_3(o,y,E,V,p,f,b):null,M=Stream(o,f,p,E),D=f.eventProcessor||EventProcessor(o,f,p,E,l,V),S=Requestor(o,f,p),w={},I=f.streaming,H=!1,T=!1,P=!0,U=f.stateProvider,L=Identity(null,function(e,t){(function(e){U||e&&C({kind:"identify",key:e.key,user:e,creationDate:(new Date).getTime()})})(e),!f.autoAliasingOptOut&&t&&t.anonymous&&e&&!e.anonymous&&J(e,t);g.hasListeners(InspectorTypes.clientIdentityChanged)&&g.onIdentityChanged(L.getUser())}),q=UserValidator(y),O=y.isEnabled()?new PersistentFlagStore(y,p,m,L,c):null;function C(e){if(p&&!(U&&U.enqueueEvent&&U.enqueueEvent(e))){if("alias"!==e.kind){if(!e.user)return void(P&&(c.warn(eventWithoutUser()),P=!1));P=!1}!v||T||o.isDoNotTrack()||(c.debug(debugEnqueueingEvent(e.kind)),D.enqueue(e))}}function z(e,t){g.hasListeners(InspectorTypes.flagDetailChanged)&&g.onFlagChanged(e.key,_(t))}function K(){g.hasListeners(InspectorTypes.flagDetailsChanged)&&g.onFlags(Object.entries(w).map(function(e){e=_slicedToArray(e,2);return{key:e[0],detail:_(e[1])}}).reduce(function(e,t){return e[t.key]=t.detail,e},{}))}function B(e,t,n,r){var o=L.getUser(),a=new Date,n={kind:"feature",key:e,user:o,value:t?t.value:null,variation:t?t.variationIndex:null,default:n,creationDate:a.getTime()},a=(o&&o.anonymous&&(n.contextKind=j(o)),w[e]);a&&(n.version=a.flagVersion||a.version,n.trackEvents=a.trackEvents,n.debugEventsUntilDate=a.debugEventsUntilDate),(r||a&&a.trackReason)&&t&&(n.reason=t.reason),C(n)}function $(e,t,n,r,o){var a,i;return w&&objectHasOwnProperty(w,e)&&w[e]&&!w[e].deleted?(a=_(i=w[e]),null!==i.value&&void 0!==i.value||(a.value=t)):a={value:t,variationIndex:null,reason:{kind:"ERROR",errorKind:"FLAG_NOT_FOUND"}},n&&B(e,a,t,r),o||(i=e,n=a,g.hasListeners(InspectorTypes.flagUsed)&&g.onFlagUsed(i,n,L.getUser())),a}function _(e){return{value:e.value,variationIndex:void 0===e.variation?null:e.variation,reason:e.reason||null}}function j(e){return e.anonymous?"anonymousUser":"user"}function J(e,t){U||e&&t&&C({kind:"alias",key:e.key,contextKind:j(e),previousKey:t.key,previousContextKind:j(t),creationDate:(new Date).getTime()})}function W(){var a;i=!0,L.getUser()&&(a=function(e){try{return JSON.parse(e)}catch(e){l.maybeReportError(new LDInvalidDataError(invalidData()))}},M.connect(L.getUser(),m,{ping:function(){c.debug(debugStreamPing());var t=L.getUser();S.fetchFlagSettings(t,m).then(function(e){deepEquals(t,L.getUser())&&R(e||{})}).catch(function(e){l.maybeReportError(new LDFlagFetchError(errorFetchingFlags(e)))})},put:function(e){e=a(e.data);e&&(c.debug(debugStreamPut()),R(e))},patch:function(e){var t,n,r,o,e=a(e.data);e&&(!(t=w[e.key])||!t.version||!e.version||t.version<e.version?(c.debug(debugStreamPatch(e.key)),n={},delete(r=extend({},e)).key,o=_(w[e.key]=r),n[e.key]=t?{previous:t.value,current:o}:{current:o},X(n),z(e,r)):c.debug(debugStreamPatchIgnored(e.key)))},delete:function(e){var t,e=a(e.data);e&&(!w[e.key]||w[e.key].version<e.version?(c.debug(debugStreamDelete(e.key)),t={},w[e.key]&&!w[e.key].deleted&&(t[e.key]={previous:w[e.key].value}),w[e.key]={version:e.version,deleted:!0},z(e,w[e.key]),X(t)):c.debug(debugStreamDeleteIgnored(e.key)))}}))}function G(){i&&(M.disconnect(),i=!1)}function R(e){var t,n,r={};if(!e)return Promise.resolve();for(t in w)objectHasOwnProperty(w,t)&&w[t]&&(e[t]&&!deepEquals(e[t].value,w[t].value)?r[t]={previous:w[t].value,current:_(e[t])}:e[t]&&!e[t].deleted||(r[t]={previous:w[t].value}));for(n in e)objectHasOwnProperty(e,n)&&e[n]&&(!w[n]||w[n].deleted)&&(r[n]={current:_(e[n])});return w=_objectSpread2({},e),K(),X(r).catch(function(){})}function X(o){var a,e=Object.keys(o);return 0<e.length&&(a={},e.forEach(function(e){var t=o[e].current,n=t?t.value:void 0,r=o[e].previous;l.emit(changeEvent+":"+e,n,r),a[e]=t?{current:n,previous:r}:{previous:r}}),l.emit(changeEvent,a),l.emit(internalChangeEvent,w),f.sendEventsOnlyForVariation||U||e.forEach(function(e){B(e,o[e].current)})),n&&O?O.saveFlags(w):Promise.resolve()}function Q(){var e=I||r&&void 0===I;e&&!i?W():!e&&i&&G(),k&&k.setStreaming(e)}function Y(e){return e===changeEvent||e.substr(0,changeEvent.length+1)===changeEvent+":"}function Z(e){p=e.environment,L.setUser(e.user),w=_objectSpread2({},e.flags),onNextTick(A)}function A(){c.info(clientInitialized()),H=!0,Q(),d.signalSuccess()}function ee(e){d.signalFailure(e)}return"string"==typeof f.bootstrap&&"LOCALSTORAGE"===f.bootstrap.toUpperCase()&&(O?n=!0:c.warn(localStorageUnavailable())),"object"===_typeof(f.bootstrap)&&(a=f.bootstrap,h=Object.keys(a),!(s=a[N="$flagsState"])&&h.length&&c.warn(bootstrapOldFormat()),!1===a.$valid&&c.warn(bootstrapInvalid()),u={},h.forEach(function(e){var t;e!==N&&"$valid"!==e&&(t={value:a[e]},s&&s[e]?t=extend(t,s[e]):t.version=0,u[e]=t)}),w=u),U?((b=U.getInitialState())?Z(b):U.on("init",Z),U.on("update",function(e){e.user&&L.setUser(e.user);e.flags&&R(e.flags)})):(F?q.validateUser(x).then(function(e){return L.setUser(e),"object"===_typeof(f.bootstrap)?A():n?O.loadFlags().then(function(e){return null==e?(w={},S.fetchFlagSettings(L.getUser(),m).then(function(e){return R(e||{})}).then(A).catch(function(e){ee(new LDFlagFetchError(errorFetchingFlags(e)))})):(w=e,onNextTick(A),S.fetchFlagSettings(L.getUser(),m).then(R).catch(function(e){return l.maybeReportError(e)}))}):S.fetchFlagSettings(L.getUser(),m).then(function(e){w=e||{},K(),A()}).catch(function(e){w={},ee(e)})}):Promise.reject(new LDInvalidEnvironmentIdError(environmentNotSpecified()))).catch(ee),{client:{waitForInitialization:function(){return d.getInitializationPromise()},waitUntilReady:function(){return d.getReadyPromise()},identify:function(e,r,t){return T?wrapPromiseCallback(Promise.resolve({}),t):U?(c.warn(identifyDisabled()),wrapPromiseCallback(Promise.resolve(transformVersionedValuesToValues(w)),t)):wrapPromiseCallback((n&&O?O.clearFlags():Promise.resolve()).then(function(){return q.validateUser(e)}).then(function(n){return S.fetchFlagSettings(n,r).then(function(e){var t=transformVersionedValuesToValues(e);return L.setUser(n),m=r,e?R(e).then(function(){return t}):t})}).then(function(e){return i&&W(),e}).catch(function(e){return l.maybeReportError(e),Promise.reject(e)}),t)},getUser:function(){return L.getUser()},variation:function(e,t){return $(e,t,!0,!1,!1).value},variationDetail:function(e,t){return $(e,t,!0,!0,!1)},track:function(e,t,n){var r;"string"!=typeof e?l.maybeReportError(new LDInvalidEventKeyError(unknownCustomEventKey(e))):(o.customEventFilter&&!o.customEventFilter(e)&&c.warn(unknownCustomEventKey(e)),r={kind:"custom",key:e,user:e=L.getUser(),url:o.getCurrentUrl(),creationDate:(new Date).getTime()},e&&e.anonymous&&(r.contextKind=j(e)),null!=t&&(r.data=t),null!=n&&(r.metricValue=n),C(r))},alias:J,on:function(e,t,n){Y(e)?(r=!0,H&&Q(),l.on(e,t,n)):l.on.apply(l,arguments)},off:function(e){var t;l.off.apply(l,arguments),Y(e)&&(t=!1,l.getEvents().forEach(function(e){Y(e)&&0<l.getEventListenerCount(e)&&(t=!0)}),t||(r=!1,i&&void 0===I&&G()))},setStreaming:function(e){(e=null===e?void 0:e)!==I&&(I=e,Q())},flush:function(e){return wrapPromiseCallback(v?D.flush():Promise.resolve(),e)},allFlags:function(){var e={};if(w)for(var t in w)objectHasOwnProperty(w,t)&&!w[t].deleted&&(e[t]=$(t,null,!f.sendEventsOnlyForVariation,!1,!0).value);return e},close:function(e){var t;return T?wrapPromiseCallback(Promise.resolve(),e):(t=function(){T=!0,w={}},wrapPromiseCallback(Promise.resolve().then(function(){if(G(),k&&k.stop(),v)return D.stop(),D.flush()}).then(t).catch(t),e))}},options:f,emitter:l,ident:L,logger:c,requestor:S,start:function(){v&&(k&&k.start(),D.start())},enqueueEvent:C,getFlagsInternal:function(){return w},getEnvironmentId:function(){return p},internalChangeEventName:internalChangeEvent}}var version="3.8.2";exports.commonBasicLogger=commonBasicLogger,exports.createConsoleLogger=createConsoleLogger,exports.errors=errors,exports.initialize=initialize,exports.messages=messages,exports.utils=utils,exports.version=version;
//# sourceMappingURL=ldclient-common.cjs.js.map
